<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How Have Countries Gold Stores Changed Throughout the Years?</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        #container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
        }
        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .country {
            stroke: #fff;
            stroke-width: 0.5;
            cursor: pointer;
        }
        .country:hover {
            stroke: #333;
            stroke-width: 2;
        }
        #controls {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        #timeSlider {
            width: 100%;
            margin: 10px 0;
        }
        #timeDisplay {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        #legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 30px;
            height: 20px;
            border: 1px solid #999;
        }
        #tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            font-size: 14px;
            z-index: 1000;
        }
        #chartModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        #chartModal.show {
            display: flex;
        }
        #chartContent {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 90%;
            position: relative;
        }
        #closeModal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
        }
        #closeModal:hover {
            color: #333;
        }
        #chartTitle {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
        }
        .controls-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Gold Reserves by Country</h1>
        <div id="fileUpload" style="text-align: center; padding: 20px;">
            <label for="csvFile" style="font-size: 16px; margin-right: 10px;">Upload CSV:</label>
            <input type="file" id="csvFile" accept=".csv" style="padding: 8px;">
        </div>
        <div id="loading" style="display: none;">Processing data...</div>
        <div id="controls" style="display: none;">
            <div id="timeDisplay">Loading...</div>
            <input type="range" id="timeSlider" min="0" max="100" value="0">
            <div class="controls-row">
                <button id="playBtn">Play</button>
                <button id="prevBtn">Previous</button>
                <button id="nextBtn">Next</button>
            </div>
            <div class="controls-row">
                <label for="speedSlider">Speed:</label>
                <input type="range" id="speedSlider" min="100" max="2000" value="500" step="100" style="width: 200px;">
                <span id="speedDisplay">0.5s</span>
            </div>
            <div id="legend"></div>
        </div>
        <svg id="map"></svg>
        <div id="tooltip"></div>
        <div id="chartModal">
            <div id="chartContent">
                <button id="closeModal">&times;</button>
                <h2 id="chartTitle"></h2>
                <canvas id="historyChart" width="740" height="500"></canvas>
            </div>
        </div>
    </div>

    <script>
        let goldData = {};
        let timePeriods = [];
        let currentPeriodIndex = 0;
        let isPlaying = false;
        let playInterval;
        let playSpeed = 500;
        
        const width = 1360;
        const height = 600;
        
        const svg = d3.select("#map")
            .attr("width", width)
            .attr("height", height);
        
        const projection = d3.geoMercator()
            .scale(200)
            .translate([width / 2, height / 1.5]);
        
        const path = d3.geoPath().projection(projection);
        
        const colorScale = d3.scaleThreshold()
            .domain([10, 100, 500, 1000, 3000, 8000])
            .range(["#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c"]);
        
        const tooltip = d3.select("#tooltip");
        
        // Comprehensive IMF to GeoJSON country name mappings
        const countryNameMap = {
            "Afghanistan, Islamic Republic of": "Afghanistan",
            "Afghanistan, Islamic Rep. of": "Afghanistan",
            "Albania": "Albania",
            "Algeria": "Algeria",
            "Argentina": "Argentina",
            "Armenia, Republic of": "Armenia",
            "Armenia, Rep. of": "Armenia",
            "Aruba": "Aruba",
            "Australia": "Australia",
            "Austria": "Austria",
            "Azerbaijan, Republic of": "Azerbaijan",
            "Azerbaijan, Rep. of": "Azerbaijan",
            "Bahamas, The": "Bahamas",
            "Bahrain, Kingdom of": "Bahrain",
            "Bangladesh": "Bangladesh",
            "Barbados": "Barbados",
            "Belarus, Republic of": "Belarus",
            "Belarus": "Belarus",
            "Belarus, Rep. of4)": "Belarus",
            "Belgium": "Belgium",
            "Belize": "Belize",
            "Benin": "Benin",
            "Bhutan": "Bhutan",
            "Bolivia": "Bolivia",
            "Bosnia and Herzegovina": "Bosnia and Herz.",
            "Botswana": "Botswana",
            "Brazil": "Brazil",
            "Brunei Darussalam": "Brunei",
            "Bulgaria": "Bulgaria",
            "Burkina Faso": "Burkina Faso",
            "Burundi": "Burundi",
            "Cabo Verde": "Cape Verde",
            "Cambodia": "Cambodia",
            "Cameroon": "Cameroon",
            "Canada": "Canada",
            "Central African Republic": "Central African Rep.",
            "Chad": "Chad",
            "Chile": "Chile",
            "China, People's Republic of": "China",
            "China, P.R.: Mainland": "China",
            "Colombia": "Colombia",
            "Comoros": "Comoros",
            "Congo, Democratic Republic of": "Dem. Rep. Congo",
            "Congo, Republic of": "Congo",
            "Costa Rica": "Costa Rica",
            "Côte d'Ivoire": "Côte d'Ivoire",
            "Ivory Coast": "Côte d'Ivoire",
            "Croatia": "Croatia",
            "Cyprus": "Cyprus",
            "Czech Republic": "Czechia",
            "Denmark": "Denmark",
            "Djibouti": "Djibouti",
            "Dominica": "Dominica",
            "Dominican Republic": "Dominican Rep.",
            "Ecuador": "Ecuador",
            "Egypt, Arab Republic of": "Egypt",
            "Egypt": "Egypt",
            "El Salvador": "El Salvador",
            "Equatorial Guinea": "Eq. Guinea",
            "Eritrea": "Eritrea",
            "Estonia": "Estonia",
            "Eswatini, Kingdom of": "eSwatini",
            "Swaziland": "eSwatini",
            "Ethiopia": "Ethiopia",
            "Fiji": "Fiji",
            "Finland": "Finland",
            "France": "France",
            "Gabon": "Gabon",
            "Gambia, The": "Gambia",
            "Georgia": "Georgia",
            "Germany": "Germany",
            "Ghana": "Ghana",
            "Greece": "Greece",
            "Guatemala": "Guatemala",
            "Guinea": "Guinea",
            "Guinea-Bissau": "Guinea-Bissau",
            "Guyana": "Guyana",
            "Haiti": "Haiti",
            "Honduras": "Honduras",
            "Hungary": "Hungary",
            "Iceland": "Iceland",
            "India": "India",
            "Indonesia": "Indonesia",
            "Iran, Islamic Republic of": "Iran",
            "Iraq": "Iraq",
            "Ireland": "Ireland",
            "Israel": "Israel",
            "Italy": "Italy",
            "Jamaica": "Jamaica",
            "Japan": "Japan",
            "Jordan": "Jordan",
            "Kazakhstan, Republic of": "Kazakhstan",
            "Kazakhstan": "Kazakhstan",
            "Kenya": "Kenya",
            "Korea, Republic of": "South Korea",
            "Kosovo, Republic of": "Kosovo",
            "Kuwait": "Kuwait",
            "Kyrgyz Republic": "Kyrgyzstan",
            "Lao People's Democratic Republic": "Laos",
            "Latvia": "Latvia",
            "Lebanon": "Lebanon",
            "Lesotho": "Lesotho",
            "Liberia": "Liberia",
            "Libya": "Libya",
            "Lithuania": "Lithuania",
            "Luxembourg": "Luxembourg",
            "Madagascar": "Madagascar",
            "Malawi": "Malawi",
            "Malaysia": "Malaysia",
            "Maldives": "Maldives",
            "Mali": "Mali",
            "Malta": "Malta",
            "Mauritania": "Mauritania",
            "Mauritius": "Mauritius",
            "Mexico": "Mexico",
            "Micronesia, Federated States of": "Micronesia",
            "Moldova": "Moldova",
            "Mongolia": "Mongolia",
            "Montenegro": "Montenegro",
            "Morocco": "Morocco",
            "Mozambique": "Mozambique",
            "Myanmar": "Myanmar",
            "Burma": "Myanmar",
            "Namibia": "Namibia",
            "Nepal": "Nepal",
            "Netherlands Antilles": "Netherlands",
            "Netherlands, The": "Netherlands",
            "New Zealand": "New Zealand",
            "Nicaragua": "Nicaragua",
            "Niger": "Niger",
            "Nigeria": "Nigeria",
            "North Macedonia, Republic of": "Macedonia",
            "Macedonia, former Yugoslav Republic of": "Macedonia",
            "Norway": "Norway",
            "Oman": "Oman",
            "Pakistan": "Pakistan",
            "Panama": "Panama",
            "Papua New Guinea": "Papua New Guinea",
            "Paraguay": "Paraguay",
            "Peru": "Peru",
            "Philippines": "Philippines",
            "Poland, Republic of": "Poland",
            "Poland": "Poland",
            "Portugal": "Portugal",
            "Qatar": "Qatar",
            "Romania": "Romania",
            "Russian Federation": "Russia",
            "Russia": "Russia",
            "Rwanda": "Rwanda",
            "Samoa": "Samoa",
            "San Marino": "San Marino",
            "Saudi Arabia": "Saudi Arabia",
            "Senegal": "Senegal",
            "Serbia, Republic of": "Serbia",
            "Serbia": "Serbia",
            "Seychelles": "Seychelles",
            "Sierra Leone": "Sierra Leone",
            "Singapore": "Singapore",
            "Slovak Republic": "Slovakia",
            "Slovenia": "Slovenia",
            "Solomon Islands": "Solomon Is.",
            "Somalia": "Somalia",
            "South Africa": "South Africa",
            "South Africa, Rep. of": "South Africa",
            "South Sudan, Republic of": "S. Sudan",
            "South Sudan": "S. Sudan",
            "Spain": "Spain",
            "Sri Lanka": "Sri Lanka",
            "Sudan": "Sudan",
            "Suriname": "Suriname",
            "Sweden": "Sweden",
            "Switzerland": "Switzerland",
            "Syrian Arab Republic": "Syria",
            "Syria": "Syria",
            "Tajikistan": "Tajikistan",
            "Tanzania, United Republic of": "Tanzania",
            "Tanzania": "Tanzania",
            "Thailand": "Thailand",
            "Timor-Leste, Democratic Republic of": "Timor-Leste",
            "Timor-Leste, Dem. Rep. of": "Timor-Leste",
            "Togo": "Togo",
            "Trinidad and Tobago": "Trinidad and Tobago",
            "Tunisia": "Tunisia",
            "Turkey": "Turkey",
            "Turkey5)": "Turkey",
            "Turkmenistan": "Turkmenistan",
            "Uganda": "Uganda",
            "Ukraine": "Ukraine",
            "United Arab Emirates": "United Arab Emirates",
            "UAE": "United Arab Emirates",
            "United Kingdom": "United Kingdom",
            "UK": "United Kingdom",
            "United States": "United States of America",
            "Uruguay": "Uruguay",
            "Uzbekistan, Republic of": "Uzbekistan",
            "Uzbekistan": "Uzbekistan",
            "Vanuatu": "Vanuatu",
            "Venezuela, Republica Bolivariana de": "Venezuela",
            "Vietnam": "Vietnam",
            "West Bank and Gaza": "Palestine",
            "Yemen, Republic of": "Yemen",
            "Yemen Arab Rep.": "Yemen",
            "Yemen, P.D. Rep.": "Yemen",
            "Zambia": "Zambia",
            "Zimbabwe": "Zimbabwe",
            "Taiwan Province of China": "Taiwan"
        };
        
        function normalizeCountryName(name) {
            return countryNameMap[name] || name;
        }

        // Auto-load CSV from same folder on page load (keeps upload as fallback)
        window.addEventListener('DOMContentLoaded', () => {
            const loading = document.getElementById("loading");
            const uploadBox = document.getElementById("fileUpload");
            loading.style.display = "block";
            uploadBox.style.display = "none";

            fetch("gold_reserves_annual_quarterly_monthly.csv")
                .then(res => {
                    if (!res.ok) throw new Error("CSV not found");
                    return res.text();
                })
                .then(text => {
                    const results = Papa.parse(text, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    processData(results.data);
                })
                .catch(err => {
                    // Fallback to manual upload if auto-load fails
                    loading.textContent = "Failed to auto-load CSV. Please upload the file.";
                    uploadBox.style.display = "block";
                    console.error(err);
                });
        });
        
        // Manual upload still works as a fallback
        document.getElementById("csvFile").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById("loading").style.display = "block";
                document.getElementById("fileUpload").style.display = "none";
                
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                    },
                    error: function(error) {
                        document.getElementById("loading").textContent = "Error parsing CSV file.";
                        console.error(error);
                    }
                });
            }
        });
        
        function processData(data) {
            const monthlyData = data.filter(d => d.period === 'month');
            
            monthlyData.forEach(row => {
                const period = row['Time Period'];
                const countryRaw = row['Country Name'];
                const tonnes = row['tonnes'];
                
                // Skip Hong Kong and Macao to avoid overwriting Mainland China
                if (countryRaw === 'China, P.R.: Hong Kong' || countryRaw === 'China, P.R.: Macao') {
                    return;
                }
                
                const country = normalizeCountryName(countryRaw);
                
                if (!goldData[period]) {
                    goldData[period] = {};
                }
                goldData[period][country] = tonnes;
            });
            
            timePeriods = Object.keys(goldData).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            
            document.getElementById("timeSlider").max = timePeriods.length - 1;
            currentPeriodIndex = timePeriods.length - 1;
            document.getElementById("timeSlider").value = currentPeriodIndex;
            
            loadWorldMap();
        }
        
        function loadWorldMap() {
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json")
                .then(function(world) {
                    const countries = topojson.feature(world, world.objects.countries);
                    
                    svg.selectAll("path")
                        .data(countries.features)
                        .enter()
                        .append("path")
                        .attr("class", "country")
                        .attr("d", path)
                        .on("mouseover", handleMouseOver)
                        .on("mouseout", handleMouseOut)
                        .on("click", handleClick);
                    
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("controls").style.display = "block";
                    
                    updateMap();
                    createLegend();
                })
                .catch(function(error) {
                    d3.json("https://unpkg.com/world-atlas@2/countries-110m.json")
                        .then(function(world) {
                            const countries = topojson.feature(world, world.objects.countries);
                            
                            svg.selectAll("path")
                                .data(countries.features)
                                .enter()
                                .append("path")
                                .attr("class", "country")
                                .attr("d", path)
                                .on("mouseover", handleMouseOver)
                                .on("mouseout", handleMouseOut)
                                .on("click", handleClick);
                            
                            document.getElementById("loading").style.display = "none";
                            document.getElementById("controls").style.display = "block";
                            
                            updateMap();
                            createLegend();
                        });
                });
        }
        
        function updateMap() {
            const currentPeriod = timePeriods[currentPeriodIndex];
            const currentData = goldData[currentPeriod] || {};
            
            const lastKnownValues = {};
            for (let i = 0; i <= currentPeriodIndex; i++) {
                const periodData = goldData[timePeriods[i]] || {};
                Object.keys(periodData).forEach(country => {
                    if (periodData[country] !== undefined && periodData[country] !== null) {
                        lastKnownValues[country] = periodData[country];
                    }
                });
            }
            
            document.getElementById("timeDisplay").textContent = currentPeriod;
            
            svg.selectAll("path")
                .transition()
                .duration(300)
                .attr("fill", function(d) {
                    const countryName = d.properties.name;
                    let tonnes = currentData[countryName];
                    if (tonnes === undefined || tonnes === null) {
                        tonnes = lastKnownValues[countryName];
                    }
                    if (tonnes !== undefined && tonnes !== null) {
                        return colorScale(tonnes);
                    }
                    return "#e0e0e0";
                });
        }
        
        function handleMouseOver(event, d) {
            const countryName = d.properties.name;
            const currentPeriod = timePeriods[currentPeriodIndex];
            const currentData = goldData[currentPeriod] || {};
            
            let tonnes = currentData[countryName];
            let isLastKnown = false;
            
            if (!tonnes && tonnes !== 0) {
                for (let i = currentPeriodIndex; i >= 0; i--) {
                    const periodData = goldData[timePeriods[i]] || {};
                    if (periodData[countryName] !== undefined && periodData[countryName] !== null) {
                        tonnes = periodData[countryName];
                        isLastKnown = true;
                        break;
                    }
                }
            }
            
            tooltip.style("display", "block")
                .html(`<strong>${countryName}</strong><br/>
                       ${tonnes !== undefined && tonnes !== null ? `Gold: ${tonnes.toFixed(2)} tonnes${isLastKnown ? ' (last known)' : ''}` : 'No data'}`)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }
        
        function handleMouseOut() {
            tooltip.style("display", "none");
        }
        
        function handleClick(event, d) {
            const countryName = d.properties.name;
            
            const historicalData = [];
            const labels = [];
            
            timePeriods.forEach(period => {
                if (goldData[period] && goldData[period][countryName] !== undefined && goldData[period][countryName] !== null) {
                    historicalData.push(goldData[period][countryName]);
                    labels.push(period);
                }
            });
            
            if (historicalData.length === 0) {
                return;
            }
            
            document.getElementById('chartTitle').textContent = `${countryName} - Gold Reserves History`;
            document.getElementById('chartModal').classList.add('show');
            
            const canvas = document.getElementById('historyChart');
            const ctx = canvas.getContext('2d');
            drawHistoryChart(ctx, historicalData, labels, countryName);
        }
        
        function drawHistoryChart(ctx, data, labels, countryName) {
            const width = 740;
            const height = 400;
            const padding = 60;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            ctx.clearRect(0, 0, width, height);
            
            const maxValue = Math.max(...data);
            const minValue = 0;
            const range = maxValue || 1;
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = height - padding - (i / 5) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText((maxValue * i / 5).toFixed(0) + ' t', padding - 10, y + 4);
            }
            
            // Draw line segments with colors based on change
            ctx.lineWidth = 3;
            
            for (let i = 0; i < data.length - 1; i++) {
                const x1 = padding + (i / (data.length - 1)) * chartWidth;
                const y1 = height - padding - (data[i] / range) * chartHeight;
                const x2 = padding + ((i + 1) / (data.length - 1)) * chartWidth;
                const y2 = height - padding - (data[i + 1] / range) * chartHeight;
                
                const change = data[i + 1] - data[i];
                
                // Set color based on change
                if (Math.abs(change) < 0.01) {
                    ctx.strokeStyle = '#FFD700'; // Yellow for no change
                } else if (change > 0) {
                    ctx.strokeStyle = '#4CAF50'; // Green for buying
                } else {
                    ctx.strokeStyle = '#f44336'; // Red for selling
                }
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
            
            // Draw small points with colors based on change from previous point
            data.forEach((value, i) => {
                const x = padding + (i / (data.length - 1)) * chartWidth;
                const y = height - padding - (value / range) * chartHeight;
                
                // First point is always black
                if (i === 0) {
                    ctx.fillStyle = '#000';
                } else {
                    // Color based on change from previous point
                    const change = value - data[i - 1];
                    
                    if (Math.abs(change) < 0.01) {
                        ctx.fillStyle = '#FFD700'; // Yellow for no change
                    } else if (change > 0) {
                        ctx.fillStyle = '#4CAF50'; // Green for increase
                    } else {
                        ctx.fillStyle = '#f44336'; // Red for decrease
                    }
                }
                
                ctx.beginPath();
                ctx.arc(x, y, 2.5, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            ctx.fillText(labels[0], padding, height - padding + 20);
            
            const midIndex = Math.floor(labels.length / 2);
            const midX = padding + (midIndex / (data.length - 1)) * chartWidth;
            ctx.fillText(labels[midIndex], midX, height - padding + 20);
            
            ctx.fillText(labels[labels.length - 1], width - padding, height - padding + 20);
            
            ctx.fillStyle = '#999';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${data.length} data points from ${labels[0]} to ${labels[labels.length - 1]}`, width / 2, height - 10);
            
            // Add legend for colors - positioned outside the chart area
            ctx.textAlign = 'left';
            ctx.font = '12px Arial';
            const legendX = width - 150;
            const legendY = height - padding + 40;
            
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(legendX, legendY);
            ctx.lineTo(legendX + 20, legendY);
            ctx.stroke();
            ctx.fillStyle = '#666';
            ctx.fillText('Buying', legendX + 25, legendY + 4);
            
            ctx.strokeStyle = '#f44336';
            ctx.beginPath();
            ctx.moveTo(legendX, legendY + 20);
            ctx.lineTo(legendX + 20, legendY + 20);
            ctx.stroke();
            ctx.fillText('Selling', legendX + 25, legendY + 24);
            
            ctx.strokeStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(legendX, legendY + 40);
            ctx.lineTo(legendX + 20, legendY + 40);
            ctx.stroke();
            ctx.fillText('No change', legendX + 25, legendY + 44);
        }
        
        function createLegend() {
            const legendData = [
                { label: "0-10", color: "#ffffcc" },
                { label: "10-100", color: "#ffeda0" },
                { label: "100-500", color: "#fed976" },
                { label: "500-1K", color: "#feb24c" },
                { label: "1K-3K", color: "#fd8d3c" },
                { label: "3K-8K", color: "#fc4e2a" },
                { label: "8K+", color: "#e31a1c" },
                { label: "No data", color: "#e0e0e0" }
            ];
            
            const legend = d3.select("#legend");
            
            legendData.forEach(item => {
                const div = legend.append("div")
                    .attr("class", "legend-item");
                
                div.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", item.color);
                
                div.append("span")
                    .text(`${item.label} tonnes`);
            });
        }
        
        document.getElementById("timeSlider").addEventListener("input", function(e) {
            currentPeriodIndex = parseInt(e.target.value);
            updateMap();
        });
        
        document.getElementById("playBtn").addEventListener("click", function() {
            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        });
        
        document.getElementById("prevBtn").addEventListener("click", function() {
            if (currentPeriodIndex > 0) {
                currentPeriodIndex--;
                document.getElementById("timeSlider").value = currentPeriodIndex;
                updateMap();
            }
        });
        
        document.getElementById("nextBtn").addEventListener("click", function() {
            if (currentPeriodIndex < timePeriods.length - 1) {
                currentPeriodIndex++;
                document.getElementById("timeSlider").value = currentPeriodIndex;
                updateMap();
            }
        });
        
        document.getElementById("speedSlider").addEventListener("input", function(e) {
            playSpeed = parseInt(e.target.value);
            document.getElementById("speedDisplay").textContent = (playSpeed / 1000).toFixed(1) + "s";
            
            if (isPlaying) {
                stopPlay();
                startPlay();
            }
        });
        
        function startPlay() {
            isPlaying = true;
            document.getElementById("playBtn").textContent = "Pause";
            
            playInterval = setInterval(function() {
                if (currentPeriodIndex < timePeriods.length - 1) {
                    currentPeriodIndex++;
                    document.getElementById("timeSlider").value = currentPeriodIndex;
                    updateMap();
                } else {
                    stopPlay();
                }
            }, playSpeed);
        }
        
        function stopPlay() {
            isPlaying = false;
            document.getElementById("playBtn").textContent = "Play";
            clearInterval(playInterval);
        }
        
        document.getElementById("closeModal").addEventListener("click", function() {
            document.getElementById("chartModal").classList.remove("show");
        });
        
        document.getElementById("chartModal").addEventListener("click", function(e) {
            if (e.target.id === "chartModal") {
                document.getElementById("chartModal").classList.remove("show");
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
</body>
</html>
