<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>How Does Gold Perform in Comparison to Other Assets?</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f0f0f;
      color: #eee;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: gold;
      margin: 0 0 6px 0;
    }
    .subtitle {
      text-align: center;
      color: #ccc;
      margin: 0 0 18px 0;
      font-weight: normal;
      font-size: 14px;
    }
    #uploader, #buttons, #toggle-container {
      text-align: center;
      margin-bottom: 15px;
    }
    button {
      margin: 5px;
      padding: 8px 16px;
      border: none;
      background: #333;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button.active {
      background: gold;
      color: #000;
    }
    #chart {
      width: 100%;
      height: 75vh;
      border: 1px solid #333;
      border-radius: 8px;
      background: #111;
    }
    .description {
      max-width: 900px;
      margin: 10px auto 30px;
      font-size: 14px;
      color: #ccc;
      text-align: center;
      line-height: 1.5em;
    }
  </style>
</head>
<body>
  <h1>How Does Gold Perform in Comparison to Other Assets?</h1>
  <h2 class="subtitle">(Bitcoin / Oil (Brent / WTI) / S&amp;P500)</h2>

  <div id="uploader">
    <label for="csvFile">Upload your CSV:</label>
    <input type="file" id="csvFile" accept=".csv">
  </div>

  <div id="buttons">
    <button class="active" data-asset="BITCOIN">BTC</button>
    <button data-asset="Brent Oil">Brent Oil</button>
    <button data-asset="Crude Oil WTI">WTI</button>
    <button data-asset="S&P500">S&P500</button>
  </div>

  <div id="toggle-container">
    <button id="toggleBtn" class="active">Show: X / Gold</button>
  </div>

  <div id="desc" class="description">
    <strong>BTC / Gold</strong> shows how many ounces of gold one BTC is worth.<br>
    When it rises, <strong>BTC</strong> is gaining value relative to gold (BTC outperforms gold).
  </div>

  <div id="chart"></div>

  <script>
    let parsedData = [];
    let currentAsset = "BITCOIN";
    let showingXOverGold = true;

    // --- Auto-load CSV from same directory; keep uploader as fallback ---
    const CSV_PATH = encodeURI("SP500 oil gold bitcoin.csv");

    window.addEventListener("DOMContentLoaded", () => {
      updateToggleButton();
      fetch(CSV_PATH)
        .then(res => {
          if (!res.ok) throw new Error("CSV not found");
          return res.text();
        })
        .then(text => {
          const results = Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true });
          parsedData = results.data;
          // Hide uploader if auto-load worked
          const up = document.getElementById("uploader");
          if (up) up.style.display = "none";
          plotChart();
        })
        .catch(err => {
          // Leave uploader visible so the user can upload manually
          console.warn("Auto-load failed, showing uploader.", err);
        });
    });

    // --- Asset selection buttons ---
    const buttons = document.querySelectorAll("button[data-asset]");
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        buttons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentAsset = btn.dataset.asset;
        if (parsedData.length) plotChart();
      });
    });

    // --- Toggle X/Gold vs Gold/X ---
    document.getElementById("toggleBtn").addEventListener("click", () => {
      showingXOverGold = !showingXOverGold;
      updateToggleButton();
      if (parsedData.length) plotChart();
    });

    function updateToggleButton() {
      const btn = document.getElementById("toggleBtn");
      btn.textContent = showingXOverGold ? "Show: X / Gold" : "Show: Gold / X";
    }

    // --- Manual upload fallback ---
    document.getElementById("csvFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
          parsedData = results.data;
          plotChart();
        }
      });
    });

    // --- Chart logic (kept same) ---
    function plotChart() {
      const daily = [];
      parsedData.forEach(row => {
        const date = new Date(row["Date"] || row["date"]);
        const gold = parseFloat(row["Gold"] || row["gold"]);
        const asset = parseFloat(row[currentAsset]);
        if (!isNaN(gold) && !isNaN(asset) && gold > 0 && !isNaN(date)) {
          daily.push({
            date,
            x_over_gold: asset / gold,
            gold_over_x: gold / asset
          });
        }
      });

      daily.sort((a, b) => a.date - b.date);

      // Bucket into months
      const monthly = {};
      daily.forEach(d => {
        const key = d.date.getFullYear() + "-" + String(d.date.getMonth() + 1).padStart(2, "0");
        if (!monthly[key]) monthly[key] = [];
        monthly[key].push(d);
      });

      const months = Object.keys(monthly).sort();

      const createCandlestick = (field) => {
        const open = [], high = [], low = [], close = [];
        months.forEach(m => {
          const vals = monthly[m].map(v => v[field]);
          open.push(vals[0]);
          high.push(Math.max(...vals));
          low.push(Math.min(...vals));
          close.push(vals[vals.length - 1]);
        });
        return { open, high, low, close };
      };

      const ratioField = showingXOverGold ? "x_over_gold" : "gold_over_x";
      const ratioData = createCandlestick(ratioField);
      const ratioName = showingXOverGold
        ? `${currentAsset} / Gold`
        : `Gold / ${currentAsset}`;
      const shortName = currentAsset.replace("BITCOIN", "BTC");

      const trace = {
        x: months,
        open: ratioData.open,
        high: ratioData.high,
        low: ratioData.low,
        close: ratioData.close,
        increasing: { line: { color: 'limegreen' } },
        decreasing: { line: { color: 'red' } },
        type: 'candlestick',
        name: ratioName
      };

      const layout = {
        paper_bgcolor: '#111',
        plot_bgcolor: '#111',
        font: { color: '#eee' },
        dragmode: 'pan',
        hovermode: 'x unified',
        margin: { l: 60, r: 40, t: 40, b: 60 },
        title: ratioName + " Monthly Candlesticks",
        yaxis: { title: ratioName + " (log)", type: 'log', gridcolor: '#333' },
        xaxis: { rangeslider: { visible: false }, showgrid: false }
      };

      const config = { responsive: true, scrollZoom: true, displaylogo: false };

      Plotly.newPlot('chart', [trace], layout, config);

      // Update description text
      const desc = document.getElementById("desc");
      if (showingXOverGold) {
        desc.innerHTML = `
          <strong>${shortName} / Gold</strong> shows how many ounces of gold one ${shortName} is worth.<br>
          When it rises, <strong>${shortName}</strong> is gaining value relative to gold (${shortName} outperforms gold).
        `;
      } else {
        desc.innerHTML = `
          <strong>Gold / ${shortName}</strong> shows how much ${shortName} one ounce of gold can buy.<br>
          When it rises, <strong>gold</strong> is gaining value relative to ${shortName} (gold outperforms ${shortName}).
        `;
      }
    }
  </script>
</body>
</html>
